{% extends "base.html" %}
{% block main_title %} {{ title }} {% endblock %}
{% block content %}

<br>
<div style="display: flex; align-items: center; justify-content: space-between;">
    <h2>{{ event.name }}</h2>

    {% if user.is_authenticated %}
        {% with event.attendees.all as attendees %}
            {% if user in attendees %}
                <form action="{% url 'attendees' event.id %}" method="post" style="text-align: right;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Odhlásit se</button>
                </form>
            {% else %}
                <form action="{% url 'attendees' event.id %}" method="post" style="text-align: right;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Přihlásit se na akci</button>
                </form>
            {% endif %}
        {% endwith %}
    {% else %}
        <p>Pro přihlášení se na akci se prosím nejprve přihlaste.</p>
    {% endif %}
</div>

    {% if event.image %}
      <p><img src="{{ event.image.url }}" alt="{{ event.title }}"></p>
    {% endif %}

    <p><strong>Popis:</strong> {{ event.describtion }}</p>

    <p><strong>Datum:</strong> {{ event.date }}</p>

    <p><strong>Místo:</strong> {{ event.place }}</p>

    {% if event.link %}
        <p><strong>Odkaz:</strong> <a href="{{ event.link }}" target="_blank">{{ event.link }}</a></p>
    {% endif %}
    <strong>Vstupné: </strong>
        {% if event.entry %}
            <strong>Ano</strong> - více informací v popisu.
        {% else %}
            Ne
        {% endif %}
<br>
<br>
    {% if user == event.user or perms.auth.user.jeadmin %}
    <a href="{% url 'event_update' event.pk %}"> Upravit popisek </a>
    {% endif %}


{% if user.is_authenticated %}
<h4>Komentáře</h4>

    <ul>
        {% for comment in comments %}
          <li>
            {{ comment.user.username }} ({{ comment.comment }}) - {{ comment.comment_date }}
            <br>
            {% if user == comment.user or perms.auth.jeadmin%}  <!-- Zkontroluj, zda je uživatel autorem komentáře -->
                <form action="{% url 'delete_comment' comment.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">Smazat</button>
                </form>
            {% endif %}
            <br><br>
          </li>
        {% endfor %}
    </ul>

          <form action="/detail/{{event.pk}}" method="POST">
            {% csrf_token %}
              <p>Nový komentář:</p>
              <textarea name="comment" style="width: 400px; height: 50px;"></textarea>
            <input type="submit" value="Přidat nový komentář">
          </form>
    {% else %}
        <p>Musíte být přihlášeni, abyste mohli přidávat komentáře.</p>
    {% endif %}

{% if event.is_capacity_limited %}
    Momentální počet přihlášených uživatelů / kapacita:
    {% if event.capacity is not None and attendee_count == event.capacity %}
        <div style="color: red;">
            {{ attendee_count }} / {{ event.capacity }}<br>
            <span>Kapacita je plná</span>
        </div>
    {% elif event.capacity is not None and remaining_capacity <= 3 %}
        <div style="color: orange;">
            {{ attendee_count }} / {{ event.capacity }}<br>
            <span>Zbývají poslední {{ remaining_capacity }} místa </span>
        </div>
    {% else %}
        <div style="color: green;">
            {{ attendee_count }} / {{ event.capacity }}<br>
            <span>Zbývá {{ remaining_capacity }} míst</span>
        </div>
    {% endif %}
{% else %}
    <div>Momentální počet přihlášených uživatelů - neomezená kapacita: {{ attendee_count }}</div><br>
{% endif %}
<br>
    {% if user == event.user or perms.auth.user.jeadmin %}
        <p>Účastníci:</p>
        <ul>
            {% for attendee in attendees %}
                <li>
                    {{ attendee.username }} -
                    <a href="{% url 'send_email' attendee.id event.pk %}" class="btn btn-link">Poslat email</a>
                </li>
            {% empty %}
                <li>Žádní přihlášení uživatelé.</li>
            {% endfor %}
        </ul>

        {% if attendees %}
            <a href="{% url 'send_email_to_all' event.pk %}" class="btn btn-primary">Napsat všem</a>
        {% endif %}
    {% endif %}


{% endblock %}